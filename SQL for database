-- Custom method for mapping GPS to branch locations

DECLARE
lat float;
long float;
BEGIN
	lat = NEW.current_location_latlong->'latitude';
	long = NEW.current_location_latlong->'longitude';
	IF lat < -37.84376 AND lat > -37.84851 AND long > 145.10943 AND long < 145.12093
	THEN NEW.current_location_id = 10101;
	ELSIF lat < -38.141518 AND lat > -38.144795 AND long > 144.357906 AND long < 144.360507 
	THEN NEW.current_location_id = 10212;
	ELSE
	NEW.current_location_id = 00;
	END IF;
	RETURN NEW;
END;

-- This script was generated by a beta version of the ERD tool in pgAdmin 4.
-- Please log an issue at https://redmine.postgresql.org/projects/pgadmin4/issues/new if you find any bugs, including reproduction steps.
BEGIN;


CREATE TABLE IF NOT EXISTS assets."BRANCH"
(
    branch_id integer NOT NULL,
    branch_name character varying(150) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT "BRANCH_pkey" PRIMARY KEY (branch_id)
);

CREATE TABLE IF NOT EXISTS assets."COUNTRY"
(
    country_id integer NOT NULL,
    country_name character varying COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT "COUNTRY_pkey" PRIMARY KEY (country_id)
);

CREATE TABLE IF NOT EXISTS assets."ITEM"
(
    description character varying(150) COLLATE pg_catalog."default" NOT NULL,
    tracking_id bigint NOT NULL,
    default_location_id bigint NOT NULL,
    current_location_id bigint NOT NULL,
    current_location_latlong json,
    CONSTRAINT "ITEM_pkey" PRIMARY KEY (tracking_id)
);

COMMENT ON COLUMN assets."ITEM".description
    IS 'Describes the type of item.';

COMMENT ON COLUMN assets."ITEM".current_location_id
    IS 'Derived from the current_location_latlong using a lookup method';

COMMENT ON COLUMN assets."ITEM".current_location_latlong
    IS 'The JSON of the latitude and longitude as floats';

CREATE TABLE IF NOT EXISTS assets."LOCATION"
(
    "location_ID" integer NOT NULL,
    location_country integer,
    location_branch integer,
    location_sector integer,
    location_descrip character varying(150) COLLATE pg_catalog."default",
    CONSTRAINT "LOCATION_pkey" PRIMARY KEY ("location_ID")
);

CREATE TABLE IF NOT EXISTS assets."STATUS"
(
    "status_update_ID" bigint NOT NULL,
    note character varying(300) COLLATE pg_catalog."default" NOT NULL,
    updated_at timestamp without time zone NOT NULL,
    updated_by integer NOT NULL,
    "status_ID" character varying(50) COLLATE pg_catalog."default" NOT NULL,
    "tracking_ID" bigint,
    CONSTRAINT "STATUS_pkey" PRIMARY KEY ("status_update_ID")
);

COMMENT ON COLUMN assets."STATUS".updated_by
    IS 'user_id of the user changing the status';

CREATE TABLE IF NOT EXISTS userauth."GROUP"
(
    "group_ID" integer NOT NULL,
    group_name character varying(100) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT "GROUP_pkey" PRIMARY KEY ("group_ID")
);

CREATE TABLE IF NOT EXISTS userauth."GROUP_PERMISSIONS"
(
    group_id integer NOT NULL,
    permission_id integer NOT NULL,
    permission_granted_by integer NOT NULL,
    permission_granted_date timestamp without time zone NOT NULL,
    permission_revoked_by integer,
    permission_revoked_date timestamp without time zone,
    CONSTRAINT "GROUP_PERMISSIONS_pkey" PRIMARY KEY (group_id, permission_id)
);

CREATE TABLE IF NOT EXISTS userauth."PASSWORD"
(
    date_created timestamp without time zone NOT NULL,
    encrypted_password character varying(100) COLLATE pg_catalog."default" NOT NULL,
    password_salt character varying(50) COLLATE pg_catalog."default" NOT NULL,
    password_id bigint NOT NULL,
    CONSTRAINT "PASSWORD_pkey" PRIMARY KEY (password_id)
);

CREATE TABLE IF NOT EXISTS userauth."PERMISSIONS"
(
    permission_id integer NOT NULL,
    permission_name character varying(100) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT "PERMISSIONS_pkey" PRIMARY KEY (permission_id)
);

CREATE TABLE IF NOT EXISTS userauth."USER"
(
    "user_ID" integer NOT NULL,
    "group_ID" integer NOT NULL,
    password bigint NOT NULL,
    date_created timestamp without time zone NOT NULL,
    CONSTRAINT "USER_pkey" PRIMARY KEY ("user_ID")
);

ALTER TABLE IF EXISTS assets."ITEM"
    ADD CONSTRAINT "ITEM_current_location_ID_fkey" FOREIGN KEY (current_location_id)
    REFERENCES assets."LOCATION" ("location_ID") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS assets."ITEM"
    ADD CONSTRAINT "ITEM_default_location_ID_fkey" FOREIGN KEY (default_location_id)
    REFERENCES assets."LOCATION" ("location_ID") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS assets."LOCATION"
    ADD CONSTRAINT "LOCATION_location_branch_fkey" FOREIGN KEY (location_branch)
    REFERENCES assets."BRANCH" (branch_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS assets."LOCATION"
    ADD CONSTRAINT "LOCATION_location_country_fkey" FOREIGN KEY (location_country)
    REFERENCES assets."COUNTRY" (country_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS assets."STATUS"
    ADD CONSTRAINT "STATUS_tracking_ID_fkey" FOREIGN KEY ("tracking_ID")
    REFERENCES assets."ITEM" (tracking_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS assets."STATUS"
    ADD CONSTRAINT "STATUS_updated_by_fkey" FOREIGN KEY (updated_by)
    REFERENCES userauth."USER" ("user_ID") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS userauth."GROUP_PERMISSIONS"
    ADD CONSTRAINT "GROUP_PERMISSIONS_group_id_fkey" FOREIGN KEY (group_id)
    REFERENCES userauth."GROUP" ("group_ID") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS userauth."GROUP_PERMISSIONS"
    ADD CONSTRAINT "GROUP_PERMISSIONS_permission_id_fkey" FOREIGN KEY (permission_id)
    REFERENCES userauth."PERMISSIONS" (permission_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS userauth."USER"
    ADD CONSTRAINT "USER_group_ID_fkey" FOREIGN KEY ("group_ID")
    REFERENCES userauth."GROUP" ("group_ID") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;

END;
